{"version":3,"file":"store.js","sources":["uni_modules/uni-id-pages/common/store.js"],"sourcesContent":["import pagesJson from '@/pages.json'\r\nimport config from '@/uni_modules/uni-id-pages/config.js'\r\n\r\nconst uniIdCo = uniCloud.importObject(\"uni-id-co\")\r\nconst db = uniCloud.database();\r\nconst usersTable = db.collection('uni-id-users')\r\n\r\nlet hostUserInfo = uni.getStorageSync('uni-id-pages-userInfo')||{}\r\n\r\nconst data = {\r\n\tuserInfo: hostUserInfo,\r\n\thasLogin: Object.keys(hostUserInfo).length != 0\r\n}\r\n\r\n// 定义 mutations, 修改属性\r\nexport const mutations = {\r\n\t// data不为空，表示传递要更新的值(注意不是覆盖是合并),什么也不传时，直接查库获取更新\r\n\tasync updateUserInfo(data = false) {\r\n\t\tif (data) {\r\n\t\t\t// 检查是否有avatar字段但没有avatar_file字段，如果是则自动添加avatar_file\r\n\t\t\tif (data.avatar && !data.avatar_file) {\r\n\t\t\t\tdata.avatar_file = {\r\n\t\t\t\t\tname: 'avatar.png',\r\n\t\t\t\t\textname: 'png',\r\n\t\t\t\t\turl: data.avatar\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tusersTable.where('_id==$env.uid').update(data).then(e => {\r\n\t\t\t\t// console.log(e);\r\n\t\t\t\tif (e.result.updated) {\r\n\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\ttitle: \"更新成功\",\r\n\t\t\t\t\t\ticon: 'none',\r\n\t\t\t\t\t\tduration: 3000\r\n\t\t\t\t\t});\r\n\t\t\t\t\tthis.setUserInfo(data)\r\n\t\t\t\t} else {\r\n\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\ttitle: \"没有改变\",\r\n\t\t\t\t\t\ticon: 'none',\r\n\t\t\t\t\t\tduration: 3000\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t})\r\n\r\n\t\t} else {\r\n      // 不等待联网查询，立即更新用户_id确保store.userInfo中的_id是最新的\r\n      const _id = uniCloud.getCurrentUserInfo().uid\r\n      this.setUserInfo({_id},{cover:true})\r\n      // 查库获取用户信息，更新store.userInfo\r\n\t\t\tconst uniIdCo = uniCloud.importObject(\"uni-id-co\", {\r\n\t\t\t\tcustomUI: true\r\n\t\t\t})\r\n\t\t\ttry {\r\n\t\t\t\tlet res = await usersTable.where(\"'_id' == $cloudEnv_uid\")\r\n\t\t\t\t\t.field('mobile,nickname,username,email,avatar,avatar_file')\r\n\t\t\t\t\t.get()\r\n\r\n\t\t\t\tconst realNameRes = await uniIdCo.getRealNameInfo()\r\n\r\n\t\t\t\t// console.log('fromDbData',res.result.data);\r\n\t\t\t\tthis.setUserInfo({\r\n\t\t\t\t\t...res.result.data[0],\r\n\t\t\t\t\trealNameAuth: realNameRes\r\n\t\t\t\t})\r\n\t\t\t} catch (e) {\r\n\t\t\t\tthis.setUserInfo({},{cover:true})\r\n\t\t\t\tconsole.error(e.message, e.errCode);\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\tsetUserInfo(data, {cover}={cover:false}) {\r\n\t\t// console.log('set-userInfo', data);\r\n\t\t// 确保avatar_file字段始终有值\r\n\t\tif(data.avatar && !data.avatar_file) {\r\n\t\t\tconsole.log(\"自动从avatar创建avatar_file\");\r\n\t\t\tdata.avatar_file = {\r\n\t\t\t\tname: 'avatar-' + Date.now(),\r\n\t\t\t\textname: 'png',\r\n\t\t\t\turl: data.avatar\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tlet userInfo = cover?data:Object.assign(store.userInfo,data)\r\n\t\tstore.userInfo = Object.assign({},userInfo)\r\n\t\tstore.hasLogin = Object.keys(store.userInfo).length != 0\r\n\t\t// console.log('store.userInfo', store.userInfo);\r\n\t\tuni.setStorageSync('uni-id-pages-userInfo', store.userInfo)\r\n\t\treturn data\r\n\t},\r\n\tasync logout() {\r\n\t\t// 1. 已经过期就不需要调用服务端的注销接口\t2.即使调用注销接口失败，不能阻塞客户端\r\n\t\tif(uniCloud.getCurrentUserInfo().tokenExpired > Date.now()){\r\n\t\t\ttry{\r\n\t\t\t\tawait uniIdCo.logout()\r\n\t\t\t}catch(e){\r\n\t\t\t\tconsole.error(e);\r\n\t\t\t}\r\n\t\t}\r\n\t\tuni.removeStorageSync('uni_id_token');\r\n\t\tuni.setStorageSync('uni_id_token_expired', 0)\r\n    this.setUserInfo({},{cover:true})\r\n    uni.$emit('uni-id-pages-logout')\r\n\t\tuni.redirectTo({\r\n\t\t\turl: `/${pagesJson.uniIdRouter && pagesJson.uniIdRouter.loginPage ? pagesJson.uniIdRouter.loginPage: 'uni_modules/uni-id-pages/pages/login/login-withoutpwd'}`,\r\n\t\t});\r\n\t},\r\n\tloginBack (e = {}) {\r\n\t\tconst {uniIdRedirectUrl = ''} = e\r\n\t\tlet delta = 0; //判断需要返回几层\r\n\t\tlet pages = getCurrentPages();\r\n\t\t// console.log(pages);\r\n\t\tpages.forEach((page, index) => {\r\n\t\t\tif (pages[pages.length - index - 1].route.split('/')[3] == 'login') {\r\n\t\t\t\tdelta++\r\n\t\t\t}\r\n\t\t})\r\n\t\t// console.log('判断需要返回几层:', delta);\r\n\t\tif (uniIdRedirectUrl) {\r\n\t\t\treturn uni.redirectTo({\r\n\t\t\t\turl: uniIdRedirectUrl,\r\n\t\t\t\tfail: (err1) => {\r\n\t\t\t\t\tuni.switchTab({\r\n\t\t\t\t\t\turl:uniIdRedirectUrl,\r\n\t\t\t\t\t\tfail: (err2) => {\r\n\t\t\t\t\t\t\tconsole.log(err1,err2)\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t}\r\n\t\t// #ifdef H5\r\n\t\tif (e.loginType == 'weixin') {\r\n\t\t\t// console.log('window.history', window.history);\r\n\t\t\treturn window.history.go(-3)\r\n\t\t}\r\n\t\t// #endif\r\n\r\n\t\tif (delta) {\r\n\t\t\tconst page = pagesJson.pages[0]\r\n\t\t\treturn uni.reLaunch({\r\n\t\t\t\turl: `/${page.path}`\r\n\t\t\t})\r\n\t\t}\r\n\r\n\t\tuni.navigateBack({\r\n\t\t\tdelta\r\n\t\t})\r\n\t},\r\n\tloginSuccess(e = {}){\r\n\t\tconst {\r\n\t\t\tshowToast = true, toastText = '登录成功', autoBack = true, uniIdRedirectUrl = '', passwordConfirmed\r\n\t\t} = e\r\n\t\t// console.log({toastText,autoBack});\r\n\t\tif (showToast) {\r\n\t\t\tuni.showToast({\r\n\t\t\t\ttitle: toastText,\r\n\t\t\t\ticon: 'none',\r\n\t\t\t\tduration: 3000\r\n\t\t\t});\r\n\t\t}\r\n    // 异步调用（更新用户信息）防止获取头像等操作阻塞页面返回\r\n\t\tthis.updateUserInfo()\r\n\r\n\t\tuni.$emit('uni-id-pages-login-success')\r\n\r\n\t\tif (config.setPasswordAfterLogin && !passwordConfirmed) {\r\n\t\t\treturn uni.redirectTo({\r\n\t\t\t\turl: uniIdRedirectUrl ? `/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?uniIdRedirectUrl=${uniIdRedirectUrl}&loginType=${e.loginType}`: `/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?loginType=${e.loginType}`,\r\n\t\t\t\tfail: (err) => {\r\n\t\t\t\t\tconsole.log(err)\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t}\r\n\r\n\t\tif (autoBack) {\r\n\t\t\tthis.loginBack({uniIdRedirectUrl})\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\n// 先声明一个变量而不初始化\r\nlet store;\r\n\r\n// #ifdef VUE2\r\nimport Vue from 'vue'\r\n// 通过Vue.observable创建一个可响应的对象\r\nstore = Vue.observable(data)\r\n// #endif\r\n\r\n// #ifdef VUE3\r\nimport {\r\n\treactive\r\n} from 'vue'\r\n// 通过Vue.observable创建一个可响应的对象\r\nstore = reactive(data)\r\n// #endif\r\n\r\nexport { store }\r\n"],"names":["uniCloud","uni","data","uniIdCo","store","pagesJson","config","reactive"],"mappings":"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"}